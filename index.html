<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Candlestick Chart Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://unpkg.com/brain.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</head>
<body class="h-full bg-gray-100">
    <div class="flex flex-col h-full p-4">
        <div class="flex-none mb-4">
            <h1 class="text-3xl font-bold text-center text-gray-800">Advanced Candlestick Chart Simulator</h1>
        </div>
        <div id="controls" class="flex-none mb-4 space-x-4 flex justify-center items-center">
            <button id="trainBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Train
            </button>
            <div id="slider" class="w-64"></div>
            <span id="sliderValue" class="text-lg font-semibold"></span>
        </div>
        <div id="chart" class="flex-grow"></div>
    </div>

    <div id="dialog" title="Adjust Close Price" class="hidden">
        <p>Enter new close price for the last candlestick:</p>
        <input type="number" id="newClosePrice" class="w-full p-2 border rounded">
    </div>

    <script>
        // Initialize data
        let data = [];
        const totalPoints = 50;
        let lastClose = 100;

        // Generate initial random data
        for (let i = 0; i < totalPoints; i++) {
            const open = lastClose + (Math.random() - 0.5) * 5;
            const close = open + (Math.random() - 0.5) * 5;
            const high = Math.max(open, close) + Math.random() * 2;
            const low = Math.min(open, close) - Math.random() * 2;
            
            data.push({
                x: new Date(2024, 0, i + 1).getTime(),
                y: [open, high, low, close]
            });

            lastClose = close;
        }

        // Initialize chart
        const options = {
            series: [{
                data: data
            }],
            chart: {
                type: 'candlestick',
                height: '100%'
            },
            title: {
                text: 'Candlestick Chart',
                align: 'left'
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                tooltip: {
                    enabled: true
                }
            }
        };

        const chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        // Initialize brain.js network
        const net = new brain.recurrent.LSTMTimeStep();

        // jQuery UI elements
        $(document).ready(function() {
            $("#slider").slider({
                min: 0,
                max: 200,
                value: 100,
                slide: function(event, ui) {
                    $("#sliderValue").text(ui.value);
                }
            });
            
            $("#sliderValue").text($("#slider").slider("value"));

            $("#dialog").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "Update": function() {
                        const newClose = parseFloat($("#newClosePrice").val());
                        if (!isNaN(newClose)) {
                            updateChart(newClose);
                            $(this).dialog("close");
                        }
                    },
                    "Cancel": function() {
                        $(this).dialog("close");
                    }
                }
            });
        });

        // Train button functionality
        $("#trainBtn").click(function() {
            $("#newClosePrice").val(data[data.length - 1].y[3]);
            $("#dialog").dialog("open");
        });

        function updateChart(newClose) {
            const lastIndex = data.length - 1;
            data[lastIndex].y[3] = newClose;
            data[lastIndex].y[1] = Math.max(data[lastIndex].y[1], newClose);
            data[lastIndex].y[2] = Math.min(data[lastIndex].y[2], newClose);

            // Train the network
            const trainingData = data.map(d => d.y[3]);
            net.train([trainingData], { iterations: 100, log: true });

            // Generate new predictions
            const input = trainingData.slice(-5);
            const output = net.run(input);

            // Add new prediction to data
            const newDataPoint = {
                x: new Date(data[lastIndex].x).getTime() + 86400000, // Next day
                y: [output, output + Math.random() * 2, output - Math.random() * 2, output]
            };
            data.push(newDataPoint);

            // Update chart
            chart.updateSeries([{ data: data }]);
        }
    </script>
</body>
</html>